# GitLab CI/CD Pipeline pour le Projet de DÃ©tection de Fraude
# Pipeline avec stages: test et deploy

stages:
  - test
  - deploy
  - smoke

variables:
  # Variables Docker
  DOCKER_DRIVER: overlay2
  # Registry GitLab (sera automatiquement dÃ©fini par GitLab)
  CI_REGISTRY_IMAGE: $CI_REGISTRY_IMAGE
  # Python version
  PYTHON_VERSION: "3.9"

  # Faciliter Docker-in-Docker (si runner configurÃ© en mode privilÃ©giÃ©)
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

# ============================================
# STAGE: TEST
# ============================================

# Test du service d'authentification (Django)
test:auth:
  stage: test
  image: python:3.9-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: fraud_detection_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_HOST_AUTH_METHOD: trust
    DB_HOST: postgres
    DB_NAME: fraud_detection_test
    DB_USER: postgres
    DB_PASSWORD: postgres
  before_script:
    - pip install --upgrade pip
    - pip install -r auth_service/requirements.txt
    - pip install pytest pytest-django pytest-cov
    - pip show psycopg2-binary || true
    - env | grep DB_ || true
  script:
    - cd auth_service
    - python manage.py migrate
    - pytest --cov=. --cov-report=term-missing || true
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    - merge_requests
    - main
    - develop

# Test du service de transaction (FastAPI)
test:transaction:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r transaction_service/requirements.txt
    - pip install pytest pytest-asyncio httpx
  script:
    - cd transaction_service
    - pytest tests.py -v || true
  only:
    - merge_requests
    - main
    - develop

# Test du service de dÃ©tection de fraude (FastAPI)
test:fraud-detection:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r fraud_detection_service/requirements.txt
    - pip install pytest pytest-asyncio httpx
  script:
    - cd fraud_detection_service
    - pytest tests.py -v || true
  only:
    - merge_requests
    - main
    - develop

# Test du modÃ¨le ML
test:ml-model:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r ml_model/requirements.txt
    - pip install pytest
  script:
    - cd ml_model
    - python test_model.py || true
  only:
    - merge_requests
    - main
    - develop

# Tests d'intÃ©gration
test:integration:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --upgrade pip
    - pip install pytest requests
  script:
    - pytest tests/integration_tests.py -v || true
  only:
    - merge_requests
    - main
    - develop

# ============================================
# STAGE: DEPLOY
# ============================================

# Build et push de l'image Docker pour Auth Service
deploy:auth-service:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f auth_service/Dockerfile -t $CI_REGISTRY_IMAGE/auth-service:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/auth-service:latest .
    - docker push $CI_REGISTRY_IMAGE/auth-service:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/auth-service:latest
  only:
    - main
    - develop
    - AymenCasee
    - tags

# Build et push de l'image Docker pour Transaction Service
deploy:transaction-service:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f transaction_service/Dockerfile -t $CI_REGISTRY_IMAGE/transaction-service:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/transaction-service:latest .
    - docker push $CI_REGISTRY_IMAGE/transaction-service:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/transaction-service:latest
  only:
    - main
    - develop
    - tags

# Build et push de l'image Docker pour Fraud Detection Service
deploy:fraud-detection-service:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f fraud_detection_service/Dockerfile -t $CI_REGISTRY_IMAGE/fraud-detection-service:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/fraud-detection-service:latest .
    - docker push $CI_REGISTRY_IMAGE/fraud-detection-service:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/fraud-detection-service:latest
  only:
    - main
    - develop
    - tags

# ============================================
# STAGE: SMOKE (validation basique des images Docker)
# ============================================

smoke:auth-service:
  stage: smoke
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - job: deploy:auth-service
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE/auth-service:latest
    - docker rm -f auth-smoke || true
    - docker run -d --name auth-smoke $CI_REGISTRY_IMAGE/auth-service:latest
    - sleep 8
    - docker ps --filter "name=auth-smoke" --format '{{.Status}}'
    - docker logs --tail=50 auth-smoke || true
    - docker rm -f auth-smoke
  only:
    - main
    - develop

smoke:transaction-service:
  stage: smoke
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - job: deploy:transaction-service
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE/transaction-service:latest
    - docker rm -f tx-smoke || true
    - docker run -d --name tx-smoke $CI_REGISTRY_IMAGE/transaction-service:latest
    - sleep 8
    - docker ps --filter "name=tx-smoke" --format '{{.Status}}'
    - docker logs --tail=50 tx-smoke || true
    - docker rm -f tx-smoke
  only:
    - main
    - develop

smoke:fraud-detection-service:
  stage: smoke
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - job: deploy:fraud-detection-service
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE/fraud-detection-service:latest
    - docker rm -f fraud-smoke || true
    - docker run -d --name fraud-smoke $CI_REGISTRY_IMAGE/fraud-detection-service:latest
    - sleep 8
    - docker ps --filter "name=fraud-smoke" --format '{{.Status}}'
    - docker logs --tail=50 fraud-smoke || true
    - docker rm -f fraud-smoke
  only:
    - main
    - develop

# Deploy to local Kubernetes cluster (Docker Desktop K8s or local K8s)
# Requires: KUBE_CONFIG variable (base64-encoded kubeconfig) set in GitLab CI/CD settings
deploy:k8s:
  stage: deploy
  image: alpine:3.18
  before_script:
    - apk add --no-cache curl bash git
    # Download kubectl
    - curl -fsSLO https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
    # Configure kubeconfig from CI variable
    - |
      if [ -n "$KUBE_CONFIG" ]; then
        mkdir -p ~/.kube
        echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        echo "âœ“ Kubeconfig configured"
      else
        echo "âš  KUBE_CONFIG variable not set. Skipping k8s deploy."
        exit 0
      fi
    # Verify cluster access (skip job if cluster unreachable on SaaS runners)
    - |
      if ! kubectl cluster-info >/dev/null 2>&1; then
        echo "âš  Kubernetes cluster unreachable from runner. Skipping deploy."
        exit 0
      fi
    - kubectl get nodes || { echo "âš  Cluster unreachable. Skipping deploy."; exit 0; }
  script:
    - echo "Starting Kubernetes deployment..."
    # Create namespace if it doesn't exist
    - kubectl create namespace fraud-detection --dry-run=client -o yaml | kubectl apply -f -
    # Update image tags in k8s manifests to use GitLab registry
    - |
      find k8s -name "*.yaml" -type f -exec sed -i \
        -e "s|IMAGE_REGISTRY|$CI_REGISTRY_IMAGE|g" \
        -e "s|:latest|:$CI_COMMIT_SHORT_SHA|g" \
        {} \;
    # Apply k8s manifests
    - kubectl apply -f k8s/ -n fraud-detection
    # Wait for rollouts to complete
    - echo "Waiting for deployments to be ready..."
    - kubectl rollout status deployment/auth-service -n fraud-detection --timeout=5m
    - kubectl rollout status deployment/transaction-service -n fraud-detection --timeout=5m
    - kubectl rollout status deployment/fraud-detection-service -n fraud-detection --timeout=5m
    # Show deployment status
    - kubectl get deployments -n fraud-detection
    - kubectl get pods -n fraud-detection
    - kubectl get services -n fraud-detection
    - echo "âœ“ Kubernetes deployment completed successfully"
  after_script:
    - echo "Deployment summary:"
    - kubectl get all -n fraud-detection --no-headers | head -20
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "AymenCasee"'
      when: manual
  needs:
    - job: deploy:auth-service
    - job: deploy:transaction-service
    - job: deploy:fraud-detection-service
  environment:
    name: production-k8s
    url: http://localhost
    deployment_tier: production
  allow_failure: true

# Deploy to local Windows machine via local GitLab Runner
deploy:local:
  stage: deploy
  tags:
    - windows
    - local
    - shell
  before_script:
    - Write-Host "ğŸš€ DÃ©ploiement local sur Windows..." -ForegroundColor Cyan
  script:
    # Activer l'environnement virtuel
    - |
      if (Test-Path ".\venv\Scripts\Activate.ps1") {
        & .\venv\Scripts\Activate.ps1
        Write-Host "âœ“ Environnement virtuel activÃ©" -ForegroundColor Green
      } else {
        Write-Host "âœ— Environnement virtuel non trouvÃ©" -ForegroundColor Red
        exit 1
      }
    
    # Installer/mettre Ã  jour les dÃ©pendances
    - Write-Host "ğŸ“¦ Installation des dÃ©pendances..." -ForegroundColor Cyan
    - pip install --upgrade pip --quiet
    - pip install -r auth_service/requirements.txt --quiet
    - pip install -r transaction_service/requirements.txt --quiet
    - pip install -r fraud_detection_service/requirements.txt --quiet
    
    # Migrations Django
    - Write-Host "ğŸ—„ï¸ Application des migrations Django..." -ForegroundColor Cyan
    - cd auth_service
    - python manage.py migrate --noinput
    - cd ..
    
    # ArrÃªter les anciens services s'ils tournent
    - Write-Host "ğŸ›‘ ArrÃªt des anciens services..." -ForegroundColor Cyan
    - Get-Process | Where-Object {$_.CommandLine -like "*manage.py*runserver*" -or $_.CommandLine -like "*uvicorn*main:app*"} | Stop-Process -Force -ErrorAction SilentlyContinue
    - Start-Sleep -Seconds 2
    
    # RedÃ©marrer les services en arriÃ¨re-plan
    - Write-Host "â–¶ï¸ DÃ©marrage des services..." -ForegroundColor Cyan
    - $pythonExe = "$PWD\venv\Scripts\python.exe"
    
    # Auth Service
    - Start-Process powershell -WindowStyle Minimized -ArgumentList "-NoExit", "-Command", "cd '$PWD\auth_service'; & '$pythonExe' manage.py runserver 0.0.0.0:8000"
    
    # Transaction Service  
    - Start-Process powershell -WindowStyle Minimized -ArgumentList "-NoExit", "-Command", "cd '$PWD\transaction_service'; & '$pythonExe' -m uvicorn main:app --host 0.0.0.0 --port 8001 --reload"
    
    # Fraud Detection Service
    - Start-Process powershell -WindowStyle Minimized -ArgumentList "-NoExit", "-Command", "cd '$PWD\fraud_detection_service'; & '$pythonExe' -m uvicorn main:app --host 0.0.0.0 --port 8002 --reload"
    
    - Write-Host "â³ Attente du dÃ©marrage des services (10s)..." -ForegroundColor Yellow
    - Start-Sleep -Seconds 10
    
    # VÃ©rifier que les services sont dÃ©marrÃ©s
    - Write-Host "âœ… VÃ©rification des services..." -ForegroundColor Cyan
    - |
      $allOk = $true
      try {
        Invoke-WebRequest -Uri "http://localhost:8000" -TimeoutSec 5 -UseBasicParsing | Out-Null
        Write-Host "  âœ“ Auth Service (8000): OK" -ForegroundColor Green
      } catch {
        Write-Host "  âœ— Auth Service (8000): ERREUR - $($_.Exception.Message)" -ForegroundColor Red
        $allOk = $false
      }
    - |
      try {
        Invoke-WebRequest -Uri "http://localhost:8001/health" -TimeoutSec 5 -UseBasicParsing | Out-Null
        Write-Host "  âœ“ Transaction Service (8001): OK" -ForegroundColor Green
      } catch {
        Write-Host "  âœ— Transaction Service (8001): ERREUR - $($_.Exception.Message)" -ForegroundColor Red
        $allOk = $false
      }
    - |
      try {
        Invoke-WebRequest -Uri "http://localhost:8002/health" -TimeoutSec 5 -UseBasicParsing | Out-Null
        Write-Host "  âœ“ Fraud Detection Service (8002): OK" -ForegroundColor Green
      } catch {
        Write-Host "  âœ— Fraud Detection Service (8002): ERREUR - $($_.Exception.Message)" -ForegroundColor Red
        $allOk = $false
      }
    
    - |
      if (-not $allOk) {
        Write-Host "`nâŒ Certains services n'ont pas dÃ©marrÃ© correctement" -ForegroundColor Red
        exit 1
      }
    
    - Write-Host "`nğŸ‰ DÃ©ploiement local terminÃ© avec succÃ¨s!" -ForegroundColor Green
    - Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    - Write-Host "ğŸ” Auth Service:           http://localhost:8000" -ForegroundColor White
    - Write-Host "ğŸ’³ Transaction Service:    http://localhost:8001" -ForegroundColor White
    - Write-Host "ğŸ¤– Fraud Detection Service: http://localhost:8002" -ForegroundColor White
    - Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      when: on_success
  
  environment:
    name: local-development
    url: http://localhost:8000
  
  allow_failure: false
