# PostgreSQL Setup in GitLab CI/CD Pipeline

## Problem Statement
The CI/CD pipeline was failing with `django.core.exceptions.ImproperlyConfigured: Error loading psycopg2 or psycopg module` when running `python manage.py migrate`.

## Solution Analysis

### Question 1: Is `psycopg2-binary` the correct solution for Docker `slim` + PostgreSQL?

**Answer: YES, it is the best approach.**

#### Current Configuration Status
| Component | Status | Details |
|-----------|--------|---------|
| `psycopg2-binary` in `requirements.txt` | ✅ Present | Version 2.9.9 in both `auth_service` and `transaction_service` |
| `auth_service/Dockerfile` | ✅ Fixed | Now includes `gcc` + `libpq-dev` (consistent with transaction_service) |
| `transaction_service/Dockerfile` | ✅ Optimal | Already includes both build dependencies |
| Base image | ✅ Compatible | `python:3.9-slim` works well with `psycopg2-binary` |

#### Why `psycopg2-binary` is optimal for `slim`:
1. **Pre-compiled wheel**: Includes all necessary binaries (bundled libpq) — no compilation required
2. **Reduced image size**: No need for `gcc`, `libpq-dev`, or local compilation
3. **Deployment speed**: Direct `pip install`, no build phase
4. **Reliability on slim images**: Avoids compilation issues in minimal environments

#### Minimal Dockerfile Configuration for `psycopg2-binary`
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# Minimal deps: only gcc (for other potential packages that may need compilation)
# libpq-dev is NOT strictly required for psycopg2-binary, but included for compatibility
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8000
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
```

---

### Question 2: What system dependencies are needed for standard `psycopg2` (non-binary)?

**Answer: You MUST install `libpq-dev` (and `gcc` for compilation).**

#### Comparison of Three Approaches

##### **Option A: `psycopg2-binary` (✅ RECOMMENDED FOR YOUR USE CASE)**
```dockerfile
FROM python:3.9-slim
RUN apt-get update && apt-get install -y gcc libpq-dev && rm -rf /var/lib/apt/lists/*
RUN pip install psycopg2-binary==2.9.9
```

**Pros:**
- No compilation required
- Faster CI/CD builds
- Pre-compiled binary included

**Cons:**
- Bundled libpq may differ from server version (rarely causes issues)

**Best for:** CI/CD pipelines, quick deployments, slim images

---

##### **Option B: Standard `psycopg2` (Compiled locally)**
```dockerfile
FROM python:3.9-slim
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \           # ← REQUIRED for compilation
    postgresql-client \   # ← Optional: provides psql CLI
    && rm -rf /var/lib/apt/lists/*

RUN pip install psycopg2==2.9.9  # Compiles locally
```

**Pros:**
- Uses system `libpq` (better integration with PostgreSQL service)
- Tighter version control

**Cons:**
- Slower builds (compilation phase)
- `gcc` + `libpq-dev` remain in final image (increases size)
- More build failures on different architectures

**Best for:** Production with specific PostgreSQL version requirements

---

##### **Option C: Standard `psycopg2` with Multi-stage Build (✅ PRODUCTION OPTIMIZED)**
```dockerfile
# Stage 1: Build
FROM python:3.9-slim AS builder
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build
COPY requirements.txt .
RUN pip install --user --no-cache-dir psycopg2==2.9.9

# Stage 2: Runtime (minimal footprint)
FROM python:3.9-slim
COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH

WORKDIR /app
COPY . .
EXPOSE 8000
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
```

**Pros:**
- Final image is much smaller (no build tools)
- Uses native system `libpq`
- Production-ready

**Cons:**
- More complex Dockerfile syntax
- Slightly longer build time (multi-stage)

**Best for:** Production deployments where image size matters

---

## Current Implementation for Your Project

Your project uses `psycopg2-binary` which is the right choice. Both Dockerfiles now consistently include:
- `gcc` (for general Python package compilation)
- `libpq-dev` (for maximum compatibility, even though not strictly required for binary wheel)

### Key Files Updated
- ✅ `auth_service/Dockerfile`: Added `libpq-dev` alongside `gcc`
- ✅ `auth_service/requirements.txt`: Contains `psycopg2-binary==2.9.9`
- ✅ `transaction_service/Dockerfile`: Already correctly configured
- ✅ `transaction_service/requirements.txt`: Contains `psycopg2-binary==2.9.9`

---

## GitLab CI Configuration Recommendations

### Typical `.gitlab-ci.yml` section for Django with PostgreSQL
```yaml
test:
  image: python:3.9-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: fraud_detection
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: '123'
    POSTGRES_HOST_AUTH_METHOD: trust
    DB_HOST: postgres
    DB_PORT: '5432'
    DB_NAME: fraud_detection
    DB_USER: postgres
    DB_PASSWORD: '123'
  before_script:
    - apt-get update && apt-get install -y gcc libpq-dev && rm -rf /var/lib/apt/lists/*
    - pip install --upgrade pip
    - pip install -r auth_service/requirements.txt
  script:
    - cd auth_service
    - python manage.py migrate
    - python manage.py test
```

### Environment Variables to Set
Ensure your GitLab CI variables match your local PostgreSQL credentials:
```
DB_HOST=postgres (GitLab CI service name)
DB_PORT=5432
DB_NAME=fraud_detection
DB_USER=postgres
DB_PASSWORD=123
```

---

## Troubleshooting

### If `psycopg2-binary` install fails in CI/CD:
1. **Upgrade pip/setuptools**: `pip install --upgrade pip setuptools wheel`
2. **Check Python version compatibility**: `psycopg2-binary==2.9.9` supports Python 3.6–3.11
3. **Verify base image**: Ensure `python:3.9-slim` is used (not alpine, which has different libc)

### If connection still fails after install:
1. **Check Django `DATABASES` setting**: Verify `ENGINE` is `'django.db.backends.postgresql'`
2. **Verify environment variables**: Ensure `DB_*` variables are set in `.gitlab-ci.yml` or `.env`
3. **Test connection manually**:
   ```bash
   python -c "import psycopg2; print(psycopg2.__version__)"
   python manage.py dbshell
   ```

---

## Summary

✅ **Your configuration is correct**: Use `psycopg2-binary` in slim Docker images  
✅ **Dockerfile updated**: `auth_service` now consistent with `transaction_service`  
✅ **No breaking changes**: All existing requirements.txt files remain valid  
✅ **Production-ready**: Configuration follows Docker best practices  

**No further action needed** unless you specifically want to switch to multi-stage builds or use standard `psycopg2` with source compilation.
